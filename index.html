<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯è®€æ›¸ç®¡å®¶ v3.1 (å¯ç·¨è¼¯ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .book-card { transition: all 0.3s; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .book-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .off-rotation { opacity: 0.7; filter: grayscale(0.9); }
        .tag-badge { font-size: 0.75rem; margin-right: 5px; opacity: 0.8; }
        .heatmap-box { width: 15px; height: 15px; border-radius: 3px; display: inline-block; margin-right: 2px; background-color: #e9ecef; }
        .heatmap-active { background-color: #198754; }
        .notes-area { display: none; background-color: #fffbe6; border-radius: 5px; padding: 10px; margin-top: 10px; border: 1px solid #ffeeba; }
        
        /* è®€å–é®ç½© */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .sync-status { position: fixed; bottom: 10px; left: 10px; font-size: 0.8rem; color: #6c757d; z-index: 1000;}
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 fw-bold text-primary">æ­£åœ¨èˆ‡é›²ç«¯åŒæ­¥ä¸­...</div>
</div>

<div class="sync-status" id="syncStatus">å°šæœªåŒæ­¥</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#"><i class="fas fa-cloud"></i> é›²ç«¯è®€æ›¸ç®¡å®¶</a>
        <button class="btn btn-sm btn-light text-primary fw-bold" onclick="forceSync()">
            <i class="fas fa-sync-alt"></i> ç«‹å³åŒæ­¥
        </button>
    </div>
</nav>

<div class="container pb-5">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h4 class="mb-0 text-secondary" style="font-size: 1.1rem;">
                <i class="fas fa-fire text-danger"></i> é–±è®€ç†±åŠ›åœ– (è¿‘7å¤©)
                <span id="heatmapContainer" class="ms-2"></span>
            </h4>
        </div>
        <div class="col-md-4 text-end mt-3 mt-md-0">
            <button class="btn btn-warning w-100 shadow fw-bold text-dark" onclick="pickRandomBook()">
                <i class="fas fa-dice fa-lg"></i> éš¨æ©ŸæŠ½é¸ä»Šæ—¥è®€ç‰©
            </button>
        </div>
    </div>

    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-white py-3 cursor-pointer" data-bs-toggle="collapse" data-bs-target="#addArea">
            <h5 class="m-0 text-primary"><i class="fas fa-plus-circle"></i> æ–°å¢å­¸ç¿’é …ç›®</h5>
        </div>
        <div id="addArea" class="collapse show">
            <div class="card-body">
                <form id="addForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">é …ç›®åç¨±</label>
                            <input type="text" class="form-control" id="title" placeholder="ä¾‹å¦‚ï¼šä¸­é†«åŸºç¤ç†è«–" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">é€²åº¦é¡å‹</label>
                            <select class="form-select" id="typeSelect" onchange="toggleTypeInput('add')">
                                <option value="numeric">ğŸ”¢ æ•¸å­—è¨ˆæ•¸ (é æ•¸/é›†æ•¸)</option>
                                <option value="milestone">ğŸ“ è‡ªè¨‚æ¸…å–® (ç« ç¯€å/ç©´ä½å)</option>
                            </select>
                        </div>

                        <div class="col-md-4 type-numeric-add">
                            <label class="form-label">ç¸½æ•¸é‡</label>
                            <input type="number" class="form-control" id="totalNum" placeholder="300">
                        </div>
                        <div class="col-md-2 type-numeric-add">
                            <label class="form-label">å–®ä½</label>
                            <input type="text" class="form-control" id="unit" value="é ">
                        </div>

                        <div class="col-12 type-milestone-add" style="display:none;">
                            <label class="form-label">è¼¸å…¥é€²åº¦åˆ—è¡¨ (ä¸€è¡Œä¸€å€‹)</label>
                            <textarea class="form-control" id="milestoneList" rows="3" placeholder="æ‰‹å¤ªé™°è‚ºç¶“&#10;æ‰‹é™½æ˜å¤§è…¸ç¶“1~5ç©´&#10;æ‰‹é™½æ˜å¤§è…¸ç¶“6~10ç©´"></textarea>
                            <div class="form-text">è«‹æŒ‰ Enter æ›è¡Œä¾†å€åˆ†æ¯å€‹é€²åº¦é»ã€‚</div>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">æ¨™ç±¤ (é¸å¡«)</label>
                            <input type="text" class="form-control" id="tags" placeholder="ä¸­é†«, è€ƒè©¦">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">é è¨ˆå®Œæˆæ—¥ (é¸å¡«)</label>
                            <input type="date" class="form-control" id="targetDate">
                        </div>
                        
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-success px-5 fw-bold">åŠ å…¥é›²ç«¯æ¸…å–®</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary rounded-pill me-1 active" onclick="filterBooks('all')">å…¨éƒ¨</button>
        <span id="tagFilters"></span>
    </div>

    <div id="bookList" class="row g-4"></div>
</div>

<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center border-0 shadow-lg">
            <div class="modal-header bg-warning justify-content-center">
                <h4 class="modal-title fw-bold">âœ¨ ä»Šæ—¥å‘½å®šè®€ç‰© âœ¨</h4>
            </div>
            <div class="modal-body py-5">
                <h2 id="pickedTitle" class="mb-3 text-primary fw-bold"></h2>
                <div id="pickedProgress" class="text-muted fs-5"></div>
                <p id="pickedTarget" class="mt-3 badge bg-info text-dark"></p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-dark" data-bs-dismiss="modal">é–‹å§‹é–±è®€</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="fas fa-edit"></i> ç·¨è¼¯é …ç›®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="mb-3">
                        <label class="form-label">é …ç›®åç¨±</label>
                        <input type="text" class="form-control" id="editTitle" required>
                    </div>
                    
                    <div id="editNumericArea" class="row g-3 mb-3">
                        <div class="col-8">
                            <label class="form-label">ç¸½æ•¸é‡ (æ›´æ”¹ä¸æœƒå½±éŸ¿ç›®å‰é€²åº¦)</label>
                            <input type="number" class="form-control" id="editTotal">
                        </div>
                        <div class="col-4">
                            <label class="form-label">å–®ä½</label>
                            <input type="text" class="form-control" id="editUnit">
                        </div>
                    </div>

                    <div id="editMilestoneArea" class="mb-3" style="display:none;">
                        <label class="form-label">é€²åº¦æ¸…å–® (å¯ä¿®æ”¹å…§å®¹ï¼Œé †åºå°æ‡‰é€²åº¦)</label>
                        <textarea class="form-control" id="editMilestoneList" rows="5"></textarea>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">æ¨™ç±¤</label>
                            <input type="text" class="form-control" id="editTags">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">é è¨ˆå®Œæˆæ—¥</label>
                            <input type="date" class="form-control" id="editTargetDate">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">å„²å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ==========================================
    // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbza6JC8hrPf2t2csUUJMCdFTEWHC6yurinD1Rdm-W1qZUgXlasiztdiHM38PfMU9koB/exec"; 
    // ==========================================

    let books = [];
    let currentFilter = 'all';

    document.addEventListener('DOMContentLoaded', () => {
        if(API_URL.includes("æ‚¨çš„_GOOGLE")) {
            alert("è«‹å…ˆä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ API_URLï¼");
            document.getElementById('loadingOverlay').style.display = 'none';
        } else {
            loadFromCloud();
        }
    });

    // --- é›²ç«¯åŒæ­¥æ ¸å¿ƒ ---
    function loadFromCloud() {
        showLoading(true);
        updateStatus("æ­£åœ¨ä¸‹è¼‰æœ€æ–°é€²åº¦...");
        fetch(API_URL)
            .then(response => response.json())
            .then(data => {
                books = data;
                // è³‡æ–™ä¿®æ­£ï¼šç¢ºä¿æ¯æœ¬æ›¸éƒ½æœ‰ unit æ¬„ä½
                books.forEach(b => { if(!b.unit) b.unit = ''; });
                renderBooks();
                renderTags();
                renderHeatmap();
                updateStatus("âœ… åŒæ­¥å®Œæˆ " + new Date().toLocaleTimeString());
                showLoading(false);
            })
            .catch(error => {
                console.error('Error:', error);
                updateStatus("âŒ é€£ç·šå¤±æ•—");
                showLoading(false);
                alert("ç„¡æ³•é€£ç·šï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€ã€‚");
            });
    }

    function saveToCloud() {
        updateStatus("æ­£åœ¨å„²å­˜è‡³é›²ç«¯...");
        renderBooks();
        renderTags();
        renderHeatmap();
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(books)
        })
        .then(response => response.json())
        .then(result => {
            if(result.result === 'success') updateStatus("âœ… å„²å­˜æˆåŠŸ " + new Date().toLocaleTimeString());
            else updateStatus("âŒ å„²å­˜å¤±æ•—");
        })
        .catch(error => updateStatus("âŒ ä¸Šå‚³å¤±æ•—"));
    }

    function forceSync() { loadFromCloud(); }
    function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
    function updateStatus(msg) { document.getElementById('syncStatus').innerText = msg; }

    // --- UI é‚è¼¯ ---
    function toggleTypeInput(mode) {
        if(mode === 'add') {
            const type = document.getElementById('typeSelect').value;
            document.querySelectorAll('.type-numeric-add').forEach(el => el.style.display = type === 'numeric' ? 'block' : 'none');
            document.querySelectorAll('.type-milestone-add').forEach(el => el.style.display = type === 'milestone' ? 'block' : 'none');
        }
    }

    // æ–°å¢
    document.getElementById('addForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const type = document.getElementById('typeSelect').value;
        const title = document.getElementById('title').value;
        const tagsInput = document.getElementById('tags').value;
        const targetDate = document.getElementById('targetDate').value;

        let newBook = {
            id: Date.now(),
            title: title,
            type: type,
            tags: tagsInput ? tagsInput.split(/[,ï¼Œ]/).map(t=>t.trim()).filter(t=>t) : [],
            targetDate: targetDate,
            notes: '',
            inRotation: true,
            logs: [],
            current: 0
        };

        if (type === 'numeric') {
            newBook.total = parseInt(document.getElementById('totalNum').value);
            newBook.unit = document.getElementById('unit').value || 'é ';
            newBook.milestones = [];
        } else {
            const lines = document.getElementById('milestoneList').value.split('\n').map(l=>l.trim()).filter(l=>l);
            newBook.milestones = lines;
            newBook.total = lines.length;
            newBook.unit = 'é€²åº¦';
        }

        if(newBook.total === 0) { alert('ç¸½æ•¸é‡ä¸èƒ½ç‚º 0'); return; }

        books.push(newBook);
        saveToCloud();
        this.reset();
        document.getElementById('typeSelect').value = 'numeric';
        toggleTypeInput('add');
    });

    // æ¸²æŸ“æ›¸ç±åˆ—è¡¨ (å·²ä¿®æ­£ï¼šé¡¯ç¤ºå–®ä½)
    function renderBooks() {
        const list = document.getElementById('bookList');
        list.innerHTML = '';
        const filtered = currentFilter === 'all' ? books : books.filter(b => b.tags.includes(currentFilter));

        if (filtered.length === 0) {
            list.innerHTML = '<div class="col-12 text-center text-muted py-4">æ²’æœ‰ç¬¦åˆçš„é …ç›®</div>';
            return;
        }

        filtered.forEach(book => {
            const percent = book.total > 0 ? Math.round((book.current / book.total) * 100) : 0;
            const isDone = book.current >= book.total;
            const opacityClass = book.inRotation ? '' : 'off-rotation';
            
            let pacingMsg = '';
            if (book.targetDate && !isDone) {
                const today = new Date();
                const target = new Date(book.targetDate);
                const diffDays = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                const remain = book.total - book.current;
                
                if (diffDays <= 0) pacingMsg = '<span class="text-danger small">âš ï¸ æœŸé™å·²é</span>';
                else {
                    const daily = (remain / diffDays).toFixed(1);
                    pacingMsg = `<span class="badge bg-info text-dark small">å‰© ${diffDays} å¤©ï¼Œæ—¥è®€ ${daily} ${book.unit}</span>`;
                }
            }

            let progressText = '';
            // ã€ä¿®æ­£ 1ã€‘é€™è£¡å¢åŠ é¡¯ç¤ºå–®ä½çš„é‚è¼¯
            if (book.type === 'numeric') {
                progressText = `<span class="fw-bold">${book.current}</span> / ${book.total} ${book.unit}`;
            } else {
                const currentStageName = book.current < book.total ? book.milestones[book.current] : "ğŸ‰ å…¨æ•¸å®Œæˆ";
                progressText = `<span class="fw-bold text-primary">${currentStageName}</span>`;
            }

            const tagsHtml = book.tags.map(t => `<span class="badge bg-secondary tag-badge">${t}</span>`).join('');

            const html = `
                <div class="col-md-6 col-lg-4">
                    <div class="card book-card h-100 ${opacityClass}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title fw-bold text-truncate" style="max-width: 80%;" title="${book.title}">${book.title}</h5>
                                <div class="dropdown">
                                    <button class="btn btn-link text-secondary p-0" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="openEditModal(${book.id})"><i class="fas fa-edit me-2"></i>ç·¨è¼¯é …ç›®</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="toggleRotation(${book.id})">${book.inRotation ? 'â›” æš«åœæŠ½é¸' : 'âœ… åŠ å…¥æŠ½é¸'}</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteBook(${book.id})"><i class="fas fa-trash-alt me-2"></i>åˆªé™¤</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mb-2">${tagsHtml}</div>
                            
                            <div class="d-flex justify-content-between small text-muted mb-1">
                                <span>${percent}% (${progressText})</span> 
                            </div>

                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar ${isDone ? 'bg-success' : 'bg-primary'}" role="progressbar" style="width: ${percent}%"></div>
                            </div>
                            <div class="text-end mb-2">${pacingMsg}</div>

                            <div class="bg-light p-2 rounded mb-2 text-center">
                                ${book.type === 'numeric' ? `
                                    <div class="input-group input-group-sm">
                                        <button class="btn btn-outline-secondary" onclick="updateProgress(${book.id}, -1)">-</button>
                                        <input type="number" class="form-control text-center" value="${book.current}" 
                                            onchange="updateProgress(${book.id}, this.value - ${book.current})">
                                        <button class="btn btn-outline-primary" onclick="updateProgress(${book.id}, 1)">+</button>
                                    </div>
                                ` : `
                                    <div class="d-flex justify-content-between align-items-center">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="updateProgress(${book.id}, -1)" ${book.current===0?'disabled':''}><i class="fas fa-arrow-left"></i></button>
                                        <div class="flex-grow-1 px-2 small text-truncate text-center text-muted">
                                            ${book.current + 1 < book.total ? 'ä¸‹å€‹: '+book.milestones[book.current+1] : ''}
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="updateProgress(${book.id}, 1)" ${isDone?'disabled':''}><i class="fas fa-check"></i></button>
                                    </div>
                                `}
                            </div>

                            <button class="btn btn-sm btn-link text-decoration-none w-100 text-start text-secondary p-0" onclick="toggleNotes(${book.id})">
                                <i class="far fa-edit"></i> ç­†è¨˜ ${book.notes ? '(æœ‰è³‡æ–™)' : ''}
                            </button>
                            <div id="note-${book.id}" class="notes-area">
                                <textarea class="form-control form-control-sm" rows="3" placeholder="è¼¸å…¥ç­†è¨˜å¾Œé»æ“Šå¤–è™•è‡ªå‹•å„²å­˜..." onchange="saveNote(${book.id}, this.value)">${book.notes || ''}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            list.innerHTML += html;
        });
    }

    // --- ç·¨è¼¯åŠŸèƒ½é‚è¼¯ (æ–°å¢) ---
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    function openEditModal(id) {
        const book = books.find(b => b.id === id);
        if(!book) return;

        document.getElementById('editId').value = book.id;
        document.getElementById('editTitle').value = book.title;
        document.getElementById('editTags').value = book.tags.join(', ');
        document.getElementById('editTargetDate').value = book.targetDate;

        const numArea = document.getElementById('editNumericArea');
        const mileArea = document.getElementById('editMilestoneArea');

        if(book.type === 'numeric') {
            numArea.style.display = 'flex';
            mileArea.style.display = 'none';
            document.getElementById('editTotal').value = book.total;
            document.getElementById('editUnit').value = book.unit;
        } else {
            numArea.style.display = 'none';
            mileArea.style.display = 'block';
            document.getElementById('editMilestoneList').value = book.milestones.join('\n');
        }

        editModal.show();
    }

    function saveEdit() {
        const id = parseInt(document.getElementById('editId').value);
        const book = books.find(b => b.id === id);
        if(!book) return;

        book.title = document.getElementById('editTitle').value;
        const tagsVal = document.getElementById('editTags').value;
        book.tags = tagsVal ? tagsVal.split(/[,ï¼Œ]/).map(t=>t.trim()).filter(t=>t) : [];
        book.targetDate = document.getElementById('editTargetDate').value;

        if(book.type === 'numeric') {
            const newTotal = parseInt(document.getElementById('editTotal').value);
            if(newTotal > 0) book.total = newTotal;
            book.unit = document.getElementById('editUnit').value;
        } else {
            const lines = document.getElementById('editMilestoneList').value.split('\n').map(l=>l.trim()).filter(l=>l);
            if(lines.length > 0) {
                book.milestones = lines;
                book.total = lines.length;
            }
        }

        editModal.hide();
        saveToCloud(); // å„²å­˜ä¸¦åŒæ­¥
    }

    // --- å…¶ä»–åŠŸèƒ½ (ä¸è®Š) ---
    function updateProgress(id, change) {
        const book = books.find(b => b.id === id);
        if (!book) return;
        let newVal = parseInt(book.current) + parseInt(change);
        if (newVal < 0) newVal = 0;
        if (newVal > book.total) newVal = book.total;

        if (newVal > book.current) {
            const todayStr = new Date().toISOString().split('T')[0];
            if (!book.logs) book.logs = [];
            if (!book.logs.includes(todayStr)) book.logs.push(todayStr);
        }
        book.current = newVal;
        if (book.current >= book.total && book.inRotation) {
            if(confirm(`æ­å–œå®Œæˆã€Œ${book.title}ã€ï¼\nè¦å°‡å…¶å¾æŠ½é¸æ¸…å–®ä¸­ç§»é™¤å—ï¼Ÿ`)) book.inRotation = false;
        }
        saveToCloud();
    }

    function saveNote(id, text) {
        const book = books.find(b => b.id === id);
        if(book) { book.notes = text; saveToCloud(); }
    }
    function toggleNotes(id) { const el = document.getElementById(`note-${id}`); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
    function toggleRotation(id) { const book = books.find(b => b.id === id); if(book) { book.inRotation = !book.inRotation; saveToCloud(); } }
    function deleteBook(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿé€™æœƒåŒæ­¥åˆªé™¤é›²ç«¯è³‡æ–™ã€‚')) { books = books.filter(b => b.id !== id); saveToCloud(); } }
    
    function renderTags() {
        const allTags = new Set();
        books.forEach(b => { if(b.tags) b.tags.forEach(t => allTags.add(t)); });
        const container = document.getElementById('tagFilters');
        container.innerHTML = '';
        allTags.forEach(tag => { container.innerHTML += `<button class="btn btn-sm btn-outline-secondary rounded-pill me-1" onclick="filterBooks('${tag}')">#${tag}</button>`; });
    }
    function filterBooks(tag) { currentFilter = tag; renderBooks(); }
    
    function renderHeatmap() {
        const container = document.getElementById('heatmapContainer');
        container.innerHTML = '';
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(today.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            const hasActivity = books.some(b => b.logs && b.logs.includes(dateStr));
            const div = document.createElement('div');
            div.className = `heatmap-box ${hasActivity ? 'heatmap-active' : ''}`;
            div.title = dateStr;
            container.appendChild(div);
        }
    }
    function pickRandomBook() {
        const pool = books.filter(b => b.inRotation && b.current < b.total);
        if (pool.length === 0) { alert('æ²’æœ‰å¯æŠ½é¸çš„æ›¸ç±ï¼'); return; }
        const picked = pool[Math.floor(Math.random() * pool.length)];
        document.getElementById('pickedTitle').innerText = picked.title;
        let progressInfo = '';
        if (picked.type === 'numeric') progressInfo = `ç›®å‰é€²åº¦ï¼š${picked.current} / ${picked.total} ${picked.unit}`;
        else progressInfo = `ç›®å‰é€²åº¦ï¼š${picked.milestones[picked.current] || 'æº–å‚™é–‹å§‹'}`;
        document.getElementById('pickedProgress').innerHTML = progressInfo;
        new bootstrap.Modal(document.getElementById('resultModal')).show();
    }
</script>
</body>
</html>